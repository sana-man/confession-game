<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Last Confession: Truth or Trial</title>
  <!-- Firebase SDK - Compat mode -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
  <style>
    :root {
      --bg: #0d0d1a;
      --text: #e0d7b8;
      --panel: #1a1a2e;
      --border: #5a452a;
      --accent: #d4af37;
      --mistake: #ff5722;
    }
    .light-mode {
      --bg: #f8f5f0;
      --text: #2c1b0d;
      --panel: #e8e0d0;
      --border: #a9a27a;
      --accent: #b8860b;
      --mistake: #e53935;
    }
    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Courier New', monospace;
      text-align: center;
      padding: 0;
      margin: 0;
      transition: background 0.3s, color 0.3s;
    }
    #container, #mainMenu, #settingsModal, #shopModal, #leaderboard {
      max-width: 700px;
      margin: 0 auto;
      padding: 40px 20px;
    }
    .panel {
      background: var(--panel);
      padding: 20px;
      border-radius: 8px;
      border-left: 3px solid var(--border);
      margin: 20px 0;
    }
    button {
      background: #2c1b0d;
      color: #e0d7b8;
      border: 1px solid var(--border);
      padding: 10px 20px;
      margin: 8px;
      font-family: inherit;
      cursor: pointer;
      border-radius: 4px;
    }
    .light-mode button {
      background: #e0d7b8;
      color: #2c1b0d;
    }
    button:hover { background: #3f2a15; }
    .light-mode button:hover { background: #d0c5a0; }
    #target, #chaosDisplay { font-size: 20px; line-height: 1.6; }
    input {
      width: 90%;
      padding: 12px;
      font-size: 18px;
      background: var(--panel);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 4px;
      outline: none;
    }
    .correct { color: #4caf50; }
    .error { color: #f44336; }
    #mistakeCounter { margin: 15px 0; font-size: 16px; color: var(--mistake); }
    .hidden { display: none; }
    .modal {
      position: fixed;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      background: var(--panel);
      padding: 20px;
      border: 1px solid var(--border);
      border-radius: 8px;
      z-index: 1000;
      color: var(--text);
      width: 90%;
      max-width: 500px;
    }
    .coins-display {
      font-size: 18px;
      font-weight: bold;
      margin: 15px 0;
      color: var(--accent);
    }
    .item { padding: 10px; border-bottom: 1px solid var(--border); }
    .item button { margin: 5px; }
  </style>
</head>
<body>

<!-- MAIN MENU -->
<div id="mainMenu">
  <h1>üïØÔ∏è Last Confession: Truth or Trial</h1>
  <p style="font-style:italic">A ritual of truth, error, and redemption</p>
  
  <div class="coins-display">ü™ô Coins: <span id="coinCount">0</span></div>

  <button onclick="startGame()">‚ñ∂Ô∏è Enter the Confessional</button>
  <button onclick="showLeaderboard()">üèÜ Hall of Confessors</button>
  <button onclick="openSettings()">‚öôÔ∏è Settings</button>
  <button onclick="openShop()">üõí Shop</button>

  <p style="margin-top: 40px; font-size: 14px;">
    Created by <strong>Sana</strong> ‚Ä¢ Morocco
  </p>
</div>

<!-- GAME CONTAINER -->
<div id="gameContainer" class="hidden">
  <!-- Confessional -->
  <div id="confessionPhase">
    <h2>üïØÔ∏è Last Confession</h2>
    <p><em>"You know what you did... Do you accept your truth?"</em></p>
    <button onclick="choosePath(true)">‚úÖ I Accept ‚Äî Face the Truth</button>
    <button onclick="choosePath(false)">‚ùå I Deny ‚Äî Test My Will</button>
    <button onclick="returnToMenu()">‚Üê Exit to Menu</button>
  </div>

  <!-- Accept Path -->
  <div id="acceptPhase" class="hidden">
    <p>Type the sentence exactly. One mistake? Start over.</p>
    <div id="target"></div>
    <input type="text" id="userInput" placeholder="Start typing..." autocomplete="off" />
    <div id="mistakeCounter">Mistakes: 0</div>
    <div id="truthMessage"></div>
    <button onclick="returnToMenu()">‚Üê Exit to Menu</button>
  </div>

  <!-- Deny Path -->
  <div id="denyPhase" class="hidden">
    <p><strong>Punishment:</strong> Type the symbols before time runs out... (20 seconds)</p>
    <div id="chaosDisplay"></div>
    <input type="text" id="chaosInput" placeholder="Type the symbols..." autocomplete="off" />
    <div id="chaosMessage"></div>
    <button onclick="returnToMenu()">‚Üê Exit to Menu</button>
  </div>
</div>

<!-- SETTINGS MODAL -->
<div id="settingsModal" class="modal hidden">
  <h3>‚öôÔ∏è Settings</h3>
  <div>
    <label>Volume: <span id="volumeValue">50%</span></label><br>
    <input type="range" id="volumeSlider" min="0" max="100" value="50" style="width:80%">
  </div>
  <div style="margin:15px 0;">
    <button onclick="toggleTheme()">üåì Toggle Light/Dark Mode</button>
  </div>
  <button onclick="closeSettings()">Close</button>
</div>

<!-- SHOP MODAL -->
<div id="shopModal" class="modal hidden">
  <h3>üõí Confessional Shop</h3>
  <div class="coins-display">ü™ô Your Coins: <span id="shopCoinCount">0</span></div>
  <div id="shopItems"></div>
  <button onclick="closeShop()">Close</button>
</div>

<!-- LEADERBOARD MODAL -->
<div id="leaderboard" class="modal hidden">
  <h3>üèÜ Hall of Confessors</h3>
  <ol id="rankings"><li>Loading...</li></ol>
  <button onclick="document.getElementById('leaderboard').classList.add('hidden')">Close</button>
</div>

<script>
  // üî• FIREBASE CONFIG
  const firebaseConfig = {
    apiKey: "AIzaSyB3Xw3uG61Fovn8O8Zha3U63DHQsmaELB8",
    authDomain: "confession-leaderboard.firebaseapp.com",
    databaseURL: "https://confession-leaderboard-default-rtdb.firebaseio.com",
    projectId: "confession-leaderboard",
    storageBucket: "confession-leaderboard.firebasestorage.app",
    messagingSenderId: "437907861763",
    appId: "1:437907861763:web:ff1bae3ee8f12a736ff936",
    measurementId: "G-BHMXGV0DE9"
  };
  firebase.initializeApp(firebaseConfig);
  const database = firebase.database();

  // === ANTI-CHEAT: DISABLE COPY/PASTE ===
  document.addEventListener('contextmenu', e => e.preventDefault());
  document.addEventListener('keydown', e => {
    if ((e.ctrlKey || e.metaKey) && ['c','v','x'].includes(e.key.toLowerCase())) {
      e.preventDefault();
    }
  });
  document.querySelectorAll('input').forEach(input => {
    input.addEventListener('paste', e => e.preventDefault());
    input.addEventListener('copy', e => e.preventDefault());
    input.addEventListener('cut', e => e.preventDefault());
  });

  // === STATE ===
  let audioVolume = 0.5;
  let totalMistakes = 0;
  let currentCoins = parseInt(localStorage.getItem('playerCoins') || '0');
  let sentencePool = [];
  let currentChaos = '';
  let chaosTimer = null;
  let allSentencesCompleted = false;

  // === DOM ===
  const mainMenu = document.getElementById('mainMenu');
  const gameContainer = document.getElementById('gameContainer');
  const coinCount = document.getElementById('coinCount');
  const shopCoinCount = document.getElementById('shopCoinCount');
  const settingsModal = document.getElementById('settingsModal');
  const shopModal = document.getElementById('shopModal');

  // === COINS & SHOP ===
  function updateCoins(amount) {
    currentCoins += amount;
    if (currentCoins < 0) currentCoins = 0;
    localStorage.setItem('playerCoins', currentCoins);
    coinCount.textContent = currentCoins;
    shopCoinCount.textContent = currentCoins;
  }

  const shopItems = [
    { id: 'desertTheme', name: 'Desert Theme', cost: 20, desc: 'Golden sands & silence' },
    { id: 'mountainTheme', name: 'Mountain Theme', cost: 30, desc: 'Cold stone & wind' },
    { id: 'noMistake', name: 'Skip One Mistake', cost: 40, desc: 'Redeem if you err' },
    { id: 'extraTime', name: 'Extra 5s in Deny', cost: 25, desc: '+5 seconds in chaos' }
  ];

  function openShop() {
    shopCoinCount.textContent = currentCoins;
    let html = '';
    shopItems.forEach(item => {
      const owned = localStorage.getItem(`owned_${item.id}`) === 'true';
      const btn = owned ? '‚úÖ Owned' : `üí∞ ${item.cost} - Buy`;
      const disabled = owned || currentCoins < item.cost ? 'disabled' : '';
      html += `
        <div class="item">
          <strong>${item.name}</strong><br>
          <em>${item.desc}</em><br>
          <button ${disabled} onclick="buyItem('${item.id}', ${item.cost})">${btn}</button>
        </div>
      `;
    });
    document.getElementById('shopItems').innerHTML = html;
    shopModal.classList.remove('hidden');
  }

  function buyItem(id, cost) {
    if (currentCoins >= cost) {
      updateCoins(-cost);
      localStorage.setItem(`owned_${id}`, 'true');
      openShop(); // refresh
    }
  }

  function closeShop() { shopModal.classList.add('hidden'); }

  // === SETTINGS ===
  document.getElementById('volumeSlider').addEventListener('input', (e) => {
    audioVolume = e.target.value / 100;
    document.getElementById('volumeValue').textContent = `${e.target.value}%`;
  });

  function toggleTheme() {
    document.body.classList.toggle('light-mode');
    localStorage.setItem('theme', document.body.classList.contains('light-mode') ? 'light' : 'dark');
  }

  function openSettings() {
    document.getElementById('volumeSlider').value = audioVolume * 100;
    document.getElementById('volumeValue').textContent = `${Math.round(audioVolume * 100)}%`;
    settingsModal.classList.remove('hidden');
  }

  function closeSettings() { settingsModal.classList.add('hidden'); }

  // === THEME ON LOAD ===
  if (localStorage.getItem('theme') === 'light') {
    document.body.classList.add('light-mode');
  }

  // === AUDIO ===
  const AudioContext = window.AudioContext || window.webkitAudioContext;
  let audioCtx = null;

  function initAudio() { if (!audioCtx) audioCtx = new AudioContext(); }

  function playWind() {
    initAudio();
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.type = 'sine'; osc.frequency.setValueAtTime(30, audioCtx.currentTime);
    gain.gain.setValueAtTime(audioVolume * 0.16, audioCtx.currentTime);
    osc.connect(gain); gain.connect(audioCtx.destination);
    osc.start(); setTimeout(() => osc.stop(), 2500);
  }

  function playChoir() {
    initAudio();
    [261.63, 329.63, 392.0].forEach((freq, i) => {
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.type = 'sine';
      osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
      gain.gain.setValueAtTime(audioVolume * 0.15, audioCtx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 2);
      osc.connect(gain); gain.connect(audioCtx.destination);
      osc.start(); osc.stop(audioCtx.currentTime + 2);
    });
  }

  function playWhispers() {
    initAudio();
    const noise = audioCtx.createBufferSource();
    const buffer = audioCtx.createBuffer(1, audioCtx.sampleRate * 0.8, audioCtx.sampleRate);
    const data = buffer.getChannelData(0);
    for (let i = 0; i < data.length; i++) {
      data[i] = (Math.random() * 2 - 1) * Math.exp(-i / (audioCtx.sampleRate * 0.3));
    }
    noise.buffer = buffer;
    const gain = audioCtx.createGain();
    gain.gain.setValueAtTime(audioVolume * 0.4, audioCtx.currentTime);
    noise.connect(gain); gain.connect(audioCtx.destination);
    noise.start();
    
    const voiceOsc = audioCtx.createOscillator();
    voiceOsc.frequency.setValueAtTime(400, audioCtx.currentTime);
    voiceOsc.type = 'sine';
    const voiceGain = audioCtx.createGain();
    voiceGain.gain.setValueAtTime(audioVolume * 0.1, audioCtx.currentTime);
    voiceGain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.7);
    voiceOsc.connect(voiceGain); voiceGain.connect(audioCtx.destination);
    voiceOsc.start(); voiceOsc.stop(audioCtx.currentTime + 0.7);
  }

  // === GAME DATA ===
  const originalSentences = [
    "The truth is a mirror dropped from heaven.",
    "In silence, the mountain speaks.",
    "You cannot hide from your own shadow.",
    "The wind carries secrets only the guilty hear.",
    "A lie is a stone in your shoe - you walk with pain.",
    "Confession is the key that unlocks the door of peace.",
    "The stars watch, but judge not.",
    "What you deny in daylight haunts you at night.",
    "Even the desert remembers your footsteps.",
    "To speak truth is to stand in fire - and not burn.",
    "The river does not apologize for its path.",
    "Your silence is louder than your words."
  ];
  const chaosSymbols = "!@#$%^&*()_+-=[]{}|;:,.<>?~`1234567890";

  // === LEADERBOARD ===
  function saveScore(name, mistakes, coinsEarned) {
    database.ref('leaderboard').push().set({
      name: name.trim() || 'Anonymous',
      mistakes: mistakes,
      coins: coinsEarned,
      timestamp: Date.now()
    });
    updateCoins(coinsEarned);
  }

  function showLeaderboard() {
    document.getElementById('leaderboard').classList.remove('hidden');
    const rankings = document.getElementById('rankings');
    rankings.innerHTML = '<li>Loading...</li>';
    database.ref('leaderboard')
      .orderByChild('mistakes')
      .limitToFirst(10)
      .once('value', (snapshot) => {
        rankings.innerHTML = '';
        if (snapshot.exists()) {
          snapshot.forEach(child => {
            const data = child.val();
            const li = document.createElement('li');
            li.textContent = `${data.name}: ${data.mistakes} mistakes`;
            rankings.appendChild(li);
          });
        } else {
          rankings.innerHTML = '<li>No confessions yet.</li>';
        }
      });
  }

  // === GAME LOGIC ===
  function startGame() {
    mainMenu.classList.add('hidden');
    gameContainer.classList.remove('hidden');
    coinCount.textContent = currentCoins;
    playWind();
  }

  function returnToMenu() {
    if (chaosTimer) clearInterval(chaosTimer);
    currentChaos = '';
    gameContainer.classList.add('hidden');
    mainMenu.classList.remove('hidden');
    // reset game state
    totalMistakes = 0;
    sentencePool = [];
    allSentencesCompleted = false;
    document.getElementById('truthMessage').textContent = "";
    document.getElementById('chaosMessage').textContent = "";
    document.getElementById('userInput').style.display = 'inline-block';
  }

  function choosePath(accept) {
    playWind();
    totalMistakes = 0;
    document.getElementById('mistakeCounter').textContent = `Mistakes: ${totalMistakes}`;
    allSentencesCompleted = false;
    currentChaos = '';

    if (accept) {
      sentencePool = [...originalSentences].sort(() => Math.random() - 0.5);
      startTypingGame();
    } else {
      startChaosChallenge();
    }
  }

  function startTypingGame() {
    if (sentencePool.length === 0) {
      allSentencesCompleted = true;
      document.getElementById('target').innerHTML = "‚ú® You have faced all truths.";
      const bonus = totalMistakes === 0 ? 10 : 0;
      const coinsEarned = 50 + bonus;
      const name = prompt("Enter your name for the Hall of Confessors:");
      if (name !== null) {
        saveScore(name, totalMistakes, coinsEarned);
        setTimeout(() => {
          document.getElementById('truthMessage').innerHTML = `üïäÔ∏è Peace granted. +${coinsEarned} coins!`;
          document.getElementById('userInput').style.display = 'none';
        }, 500);
      } else {
        document.getElementById('truthMessage').textContent = "üïäÔ∏è Peace granted.";
        document.getElementById('userInput').style.display = 'none';
      }
      return;
    }

    const currentSentence = sentencePool.shift();
    document.getElementById('target').innerHTML = '';
    for (let char of currentSentence) {
      const span = document.createElement('span');
      span.textContent = char;
      document.getElementById('target').appendChild(span);
    }
    document.getElementById('userInput').value = '';
    document.getElementById('acceptPhase').classList.remove('hidden');
    document.getElementById('denyPhase').classList.add('hidden');
    document.getElementById('confessionPhase').classList.add('hidden');
    setTimeout(() => document.getElementById('userInput').focus(), 100);
  }

  document.getElementById('userInput').addEventListener('input', () => {
    if (allSentencesCompleted) return;
    const input = document.getElementById('userInput');
    const userInput = input.value;
    const spans = document.getElementById('target').querySelectorAll('span');
    spans.forEach(span => span.classList.remove('correct', 'error'));

    let hasError = false;
    const currentSentence = sentencePool.length < 11 ? 
      originalSentences.find(s => s.includes(spans[0]?.textContent)) : 
      sentencePool[0] || spans.map(s => s.textContent).join('');
    
    for (let i = 0; i < currentSentence.length; i++) {
      if (i < userInput.length) {
        if (userInput[i] === currentSentence[i]) {
          spans[i].classList.add('correct');
        } else {
          spans[i].classList.add('error');
          hasError = true;
        }
      }
    }

    if (hasError) {
      totalMistakes++;
      document.getElementById('mistakeCounter').textContent = `Mistakes: ${totalMistakes}`;
      playWhispers();
      setTimeout(() => {
        input.value = '';
        document.getElementById('truthMessage').textContent = "‚ùå Mistake! Begin again.";
        document.getElementById('truthMessage').style.color = "#f44336";
      }, 200);
      return;
    }

    if (userInput === currentSentence) {
      playChoir();
      document.getElementById('truthMessage').textContent = "‚úÖ Truth accepted.";
      document.getElementById('truthMessage').style.color = "#4caf50";
      setTimeout(() => {
        startTypingGame();
        document.getElementById('truthMessage').textContent = "";
      }, 800);
    }
  });

  function startChaosChallenge() {
    if (!currentChaos) {
      currentChaos = '';
      for (let i = 0; i < 12; i++) {
        currentChaos += chaosSymbols.charAt(Math.floor(Math.random() * chaosSymbols.length));
      }
    }
    document.getElementById('chaosDisplay').textContent = currentChaos;
    const input = document.getElementById('chaosInput');
    input.value = '';
    input.disabled = false;
    document.getElementById('denyPhase').classList.remove('hidden');
    document.getElementById('acceptPhase').classList.add('hidden');
    document.getElementById('confessionPhase').classList.add('hidden');
    setTimeout(() => input.focus(), 100);

    let timeLeft = 20;
    if (localStorage.getItem('owned_extraTime') === 'true') timeLeft += 5;
    const timerMsg = document.getElementById('chaosMessage');
    timerMsg.textContent = `‚è≥ ${timeLeft}s`;
    timerMsg.style.color = "#e0d7b8";

    chaosTimer = setInterval(() => {
      timeLeft--;
      timerMsg.textContent = `‚è≥ ${timeLeft}s`;
      if (timeLeft <= 5) timerMsg.style.color = "#ff5722";
      if (timeLeft <= 0) {
        clearInterval(chaosTimer);
        playWhispers();
        timerMsg.textContent = "üíÄ Time's up. The whispers claim you.";
        input.disabled = true;
      }
    }, 1000);
  }

  document.getElementById('chaosInput').addEventListener('input', () => {
    const input = document.getElementById('chaosInput').value;
    if (input === currentChaos) {
      clearInterval(chaosTimer);
      playChoir();
      const coinsEarned = 20;
      updateCoins(coinsEarned);
      document.getElementById('chaosMessage').textContent = `üëÅÔ∏è You survived... +${coinsEarned} coins!`;
      document.getElementById('chaosInput').disabled = true;
    } else if (input.length > 0 && input.length <= currentChaos.length) {
      if (input !== currentChaos.substring(0, input.length)) {
        playWhispers();
        setTimeout(() => { document.getElementById('chaosInput').value = ''; }, 200);
      }
    }
  });

  // Initialize coin display
  coinCount.textContent = currentCoins;
</script>

</body>
</html>
