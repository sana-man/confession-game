<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Last Confession: Truth or Trial</title>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
  <style>
    body {
      background: #0d0d1a;
      color: #e0d7b8;
      font-family: 'Courier New', monospace;
      text-align: center;
      padding: 40px;
      margin: 0;
    }
    #container {
      max-width: 700px;
      margin: 0 auto;
    }
    #target, #chaosDisplay {
      font-size: 22px;
      line-height: 1.6;
      margin: 30px 0;
      padding: 20px;
      background: #1a1a2e;
      border-left: 3px solid #5a3a1a;
      border-radius: 5px;
    }
    #userInput, #chaosInput {
      width: 90%;
      padding: 12px;
      font-size: 18px;
      background: #0f0f1b;
      color: #e0d7b8;
      border: 1px solid #3a3a5a;
      border-radius: 4px;
      outline: none;
    }
    #userInput::placeholder, #chaosInput::placeholder {
      color: #4a4a6a;
    }
    .correct { color: #4caf50; }
    .error { color: #f44336; }
    h1 {
      color: #d4af37;
      text-shadow: 0 0 10px rgba(212, 175, 55, 0.3);
    }
    #message, #chaosMessage, #truthMessage {
      margin-top: 20px;
      font-style: italic;
      min-height: 24px;
    }
    #mistakeCounter {
      margin-top: 10px;
      font-size: 16px;
      color: #ff5722;
    }
    button {
      background: #2c1b0d;
      color: #e0d7b8;
      border: 1px solid #5a452a;
      padding: 10px 20px;
      margin: 8px;
      font-family: inherit;
      cursor: pointer;
      border-radius: 4px;
    }
    button:hover {
      background: #3f2a15;
    }
    .hidden { display: none; }
    /* Leaderboard modal */
    #leaderboard {
      position: fixed;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      background: #0f0f1b;
      padding: 20px;
      border: 1px solid #5a452a;
      border-radius: 8px;
      color: #e0d7b8;
      z-index: 1000;
    }
    #leaderboard button {
      margin-top: 15px;
    }
  </style>
</head>
<body>

<div id="container">
  <h1>üïØÔ∏è Last Confession: Truth or Trial</h1>

  <!-- PHASE 1: Confessional -->
  <div id="confessionPhase">
    <p><em>"You know what you did... Do you accept your truth?"</em></p>
    <button onclick="choosePath(true)">‚úÖ I Accept ‚Äî Face the Truth</button>
    <button onclick="choosePath(false)">‚ùå I Deny ‚Äî Test My Will</button>
  </div>

  <!-- PHASE 2: Accept ‚Üí Typing Game -->
  <div id="acceptPhase" class="hidden">
    <p>Type the sentence exactly. One mistake? Start over.</p>
    <div id="target"></div>
    <input type="text" id="userInput" placeholder="Start typing..." autocomplete="off" />
    <div id="truthMessage"></div>
    <div id="mistakeCounter">Mistakes: 0</div>
  </div>

  <!-- PHASE 3: Deny ‚Üí Symbol Chaos -->
  <div id="denyPhase" class="hidden">
    <p><strong>Punishment:</strong> Type the symbols before time runs out... (20 seconds)</p>
    <div id="chaosDisplay"></div>
    <input type="text" id="chaosInput" placeholder="Type the symbols..." autocomplete="off" />
    <div id="chaosMessage"></div>
  </div>

  <button id="restartBtn" class="hidden" onclick="restartGame()">‚Ü∫ Return to Confessional</button>
</div>

<script>
  // üî• REPLACE THIS WITH YOUR ACTUAL FIREBASE CONFIG üî•
  const firebaseConfig = {
    apiKey: "AIzaSyXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX",
    authDomain: "confession-leaderboard.firebaseapp.com",
    databaseURL: "https://confession-leaderboard-default-rtdb.firebaseio.com",
    projectId: "confession-leaderboard",
    storageBucket: "confession-leaderboard.appspot.com",
    messagingSenderId: "123456789012",
    appId: "1:123456789012:web:abcdef1234567890abcdef"
  };

  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  const database = firebase.database();

  // === AUDIO ===
  const AudioContext = window.AudioContext || window.webkitAudioContext;
  let audioCtx = null;

  function initAudio() {
    if (!audioCtx) audioCtx = new AudioContext();
  }

  function playWind() {
    initAudio();
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.type = 'sine';
    osc.frequency.setValueAtTime(30, audioCtx.currentTime);
    gain.gain.setValueAtTime(0.08, audioCtx.currentTime);
    osc.connect(gain);
    gain.connect(audioCtx.destination);
    osc.start();
    setTimeout(() => osc.stop(), 2500);
  }

  function playChoir() {
    initAudio();
    [261.63, 329.63, 392.0].forEach((freq, i) => {
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.type = 'sine';
      osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
      gain.gain.setValueAtTime(0.15, audioCtx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 2);
      osc.connect(gain);
      gain.connect(audioCtx.destination);
      osc.start();
      osc.stop(audioCtx.currentTime + 2);
    });
  }

  function playWhispers() {
    initAudio();
    const noise = audioCtx.createBufferSource();
    const buffer = audioCtx.createBuffer(1, audioCtx.sampleRate * 0.8, audioCtx.sampleRate);
    const data = buffer.getChannelData(0);
    for (let i = 0; i < data.length; i++) {
      data[i] = (Math.random() * 2 - 1) * Math.exp(-i / (audioCtx.sampleRate * 0.3));
    }
    noise.buffer = buffer;
    const gain = audioCtx.createGain();
    gain.gain.setValueAtTime(0.4, audioCtx.currentTime);
    noise.connect(gain);
    gain.connect(audioCtx.destination);
    noise.start();
    
    const voiceOsc = audioCtx.createOscillator();
    voiceOsc.frequency.setValueAtTime(400, audioCtx.currentTime);
    voiceOsc.type = 'sine';
    const voiceGain = audioCtx.createGain();
    voiceGain.gain.setValueAtTime(0.1, audioCtx.currentTime);
    voiceGain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.7);
    voiceOsc.connect(voiceGain);
    voiceGain.connect(audioCtx.destination);
    voiceOsc.start();
    voiceOsc.stop(audioCtx.currentTime + 0.7);
  }

  // === SENTENCES ===
  const originalSentences = [
    "The truth is a mirror dropped from heaven.",
    "In silence, the mountain speaks.",
    "You cannot hide from your own shadow.",
    "The wind carries secrets only the guilty hear.",
    "A lie is a stone in your shoe - you walk with pain.",
    "Confession is the key that unlocks the door of peace.",
    "The stars watch, but judge not.",
    "What you deny in daylight haunts you at night.",
    "Even the desert remembers your footsteps.",
    "To speak truth is to stand in fire - and not burn.",
    "The river does not apologize for its path.",
    "Your silence is louder than your words."
  ];

  const chaosSymbols = "!@#$%^&*()_+-=[]{}|;:,.<>?~`1234567890";

  // === DOM ===
  const confessionPhase = document.getElementById('confessionPhase');
  const acceptPhase = document.getElementById('acceptPhase');
  const denyPhase = document.getElementById('denyPhase');
  const restartBtn = document.getElementById('restartBtn');
  const targetElement = document.getElementById('target');
  const inputElement = document.getElementById('userInput');
  const messageElement = document.getElementById('truthMessage');
  const mistakeCounter = document.getElementById('mistakeCounter');

  let currentSentence = '';
  let currentChaos = '';
  let chaosTimer = null;
  let totalMistakes = 0;
  let sentencePool = [];
  let allSentencesCompleted = false;

  // === LEADERBOARD FUNCTIONS ===
  function saveScore(name, mistakes) {
    database.ref('leaderboard').push().set({
      name: name.trim() || 'Anonymous',
      mistakes: mistakes,
      timestamp: Date.now()
    });
  }

  function showLeaderboard() {
    const lb = document.createElement('div');
    lb.id = 'leaderboard';
    lb.innerHTML = `
      <h3>üèÜ Hall of Confessors</h3>
      <ol id="rankings"><li>Loading...</li></ol>
      <button onclick="document.getElementById('leaderboard').remove()">Close</button>
    `;
    document.body.appendChild(lb);

    database.ref('leaderboard')
      .orderByChild('mistakes')
      .limitToFirst(10)
      .once('value', (snapshot) => {
        const rankings = document.getElementById('rankings');
        if (snapshot.exists()) {
          rankings.innerHTML = '';
          snapshot.forEach(child => {
            const data = child.val();
            const li = document.createElement('li');
            li.textContent = `${data.name}: ${data.mistakes} mistakes`;
            rankings.appendChild(li);
          });
        } else {
          rankings.innerHTML = '<li>No confessions yet.</li>';
        }
      });
  }

  // === GAME LOGIC ===
  function choosePath(accept) {
    playWind();
    confessionPhase.classList.add('hidden');
    restartBtn.classList.remove('hidden');
    totalMistakes = 0;
    mistakeCounter.textContent = `Mistakes: ${totalMistakes}`;
    allSentencesCompleted = false;
    currentChaos = '';

    if (accept) {
      sentencePool = [...originalSentences].sort(() => Math.random() - 0.5);
      startTypingGame();
    } else {
      startChaosChallenge();
    }
  }

  function startTypingGame() {
    if (sentencePool.length === 0) {
      allSentencesCompleted = true;
      targetElement.innerHTML = "‚ú® You have faced all truths.";
      
      // Prompt for name and save
      const name = prompt("Enter your name for the Hall of Confessors:");
      if (name !== null) saveScore(name, totalMistakes);
      
      messageElement.innerHTML = `üïäÔ∏è Peace granted. <button onclick="showLeaderboard()">View Leaderboard</button>`;
      inputElement.style.display = 'none';
      return;
    }

    currentSentence = sentencePool.shift();
    targetElement.innerHTML = '';
    inputElement.style.display = 'inline-block';
    for (let char of currentSentence) {
      const span = document.createElement('span');
      span.textContent = char;
      targetElement.appendChild(span);
    }
    inputElement.value = '';
    acceptPhase.classList.remove('hidden');
    denyPhase.classList.add('hidden');
    setTimeout(() => inputElement.focus(), 100);
  }

  inputElement.addEventListener('input', () => {
    if (allSentencesCompleted) return;

    const userInput = inputElement.value;
    const spans = targetElement.querySelectorAll('span');
    spans.forEach(span => span.classList.remove('correct', 'error'));

    let hasError = false;
    for (let i = 0; i < currentSentence.length; i++) {
      if (i < userInput.length) {
        if (userInput[i] === currentSentence[i]) {
          spans[i].classList.add('correct');
        } else {
          spans[i].classList.add('error');
          hasError = true;
        }
      }
    }

    if (hasError) {
      totalMistakes++;
      mistakeCounter.textContent = `Mistakes: ${totalMistakes}`;
      playWhispers();
      setTimeout(() => {
        inputElement.value = '';
        messageElement.textContent = "‚ùå Mistake! Begin again from the start.";
        messageElement.style.color = "#f44336";
      }, 300);
      return;
    }

    if (userInput === currentSentence) {
      playChoir();
      messageElement.textContent = "‚úÖ Truth accepted. Next confession...";
      messageElement.style.color = "#4caf50";
      setTimeout(() => {
        startTypingGame();
        messageElement.textContent = "";
      }, 1000);
    }
  });

  function startChaosChallenge() {
    if (!currentChaos) {
      currentChaos = '';
      for (let i = 0; i < 12; i++) {
        currentChaos += chaosSymbols.charAt(Math.floor(Math.random() * chaosSymbols.length));
      }
    }
    document.getElementById('chaosDisplay').textContent = currentChaos;
    const input = document.getElementById('chaosInput');
    input.value = '';
    input.disabled = false;
    denyPhase.classList.remove('hidden');
    acceptPhase.classList.add('hidden');
    setTimeout(() => input.focus(), 100);

    let timeLeft = 20;
    const timerMsg = document.getElementById('chaosMessage');
    timerMsg.textContent = `‚è≥ ${timeLeft}s`;
    timerMsg.style.color = "#e0d7b8";

    chaosTimer = setInterval(() => {
      timeLeft--;
      timerMsg.textContent = `‚è≥ ${timeLeft}s`;
      if (timeLeft <= 5) timerMsg.style.color = "#ff5722";
      if (timeLeft <= 0) {
        clearInterval(chaosTimer);
        playWhispers();
        timerMsg.textContent = "üíÄ Time's up. The whispers claim you.";
        input.disabled = true;
        restartBtn.style.display = "inline-block";
      }
    }, 1000);
  }

  document.getElementById('chaosInput').addEventListener('input', () => {
    const input = document.getElementById('chaosInput').value;
    if (input === currentChaos) {
      clearInterval(chaosTimer);
      playChoir();
      document.getElementById('chaosMessage').textContent = "üëÅÔ∏è You survived...";
      document.getElementById('chaosInput').disabled = true;
      restartBtn.style.display = "inline-block";
    } else if (input.length > 0 && input.length <= currentChaos.length) {
      if (input !== currentChaos.substring(0, input.length)) {
        playWhispers();
        setTimeout(() => { document.getElementById('chaosInput').value = ''; }, 200);
      }
    }
  });

  function restartGame() {
    if (chaosTimer) clearInterval(chaosTimer);
    currentChaos = '';
    confessionPhase.classList.remove('hidden');
    acceptPhase.classList.add('hidden');
    denyPhase.classList.add('hidden');
    restartBtn.style.display = "none";
    messageElement.textContent = "";
    document.getElementById('chaosMessage').textContent = "";
    totalMistakes = 0;
    sentencePool = [];
    allSentencesCompleted = false;
    inputElement.style.display = 'inline-block';
  }
</script>

</body>
</html>
